### [译]我从未理解过的JavaScript闭包

> [i-never-understood-javascript-closures](https://medium.com/dailyjs/i-never-understood-javascript-closures-9663703368e8)

​        正如标题所述，JavaScript闭包对我来说一直是一个迷，我看了许多文章，在我工作中我也使用过闭包，有时候我甚至使用了闭包而没意识到我正在使用闭包。

​        最近我去参加一个演讲，有人用一种让我感兴趣的方式来解释它。我也准备在这篇文章中通过这种方式来解释闭包。让我向[CodeSmith](https://www.codesmith.io/)的优秀成员以及他们的*JavaScript The Hard Parts*系列表示敬意。

#### 在我们开始之前

在理解闭包之前我们需要理解一些重要的概念，其中之一就是**执行上下文**。这篇文章[What is the Execution Context & Stack in JavaScript?](http://davidshariff.com/blog/what-is-the-execution-context-in-javascript/#first-article)对执行上下文有一个很好的说明，引用这篇文章的内容：

>代码在JavaScript中执行时，执行它的环境是非常重要的，并被评估为以下几项之一：
>
>**全局代码** —— 第一次执行代码时的默认环境
>
>**函数代码** —— 每当执行流程进入到函数体时
>
>(...)
>
>(…)，让我们把`执行上下文`视为正在评估当前代码的环境/作用域

就是说，当我们启动程序时，我们从全局执行上下文开始。一些变量在全局执行上下文中声明。我们将这些变量称为全局变量。当程序调用函数时，会发生什么？几个步骤：

1. JavaScript创建一个新的执行上下文，一个局部执行上下文
2. 这个局部执行上下文将有一组自己的变量，这些变量将是局部执行上下文的本地变量
3. 这个新的执行上下文将会抛出到**执行堆栈**中。将执行堆栈视为一种机制，可以跟踪程序执行的位置。

函数什么时候结束？当它碰到一个`return`语句或者是碰到一个结束括号`}`。当函数结束时，会执行以下步骤：

1. 局部执行上下文从执行堆栈中弹出
2. 函数将返回值发送给调用上下文。调用上下文就是调用这个函数的执行上下文，它可能时全局上下文或者是另一个局部执行上下文。它取决于调用执行上下文处理这个返回值所处的位置。这个返回值可以是一个对象、一个数组、一个函数、一个布尔值，甚至是任何东西。如果这个函数没有`return`语句，将会返回`undefined`。
3. 这个局部执行上下文将会被销毁，这很重要。销毁，所有在局部执行上下文中声明的变量将会被擦除。它们将不在存在。这也是为什么它们被称为局部变量的原因。

#### 一个非常基本的例子

在我们学习闭包之前，让我们来看看下面这段代码。这似乎非常简单，阅读这篇文章的任何人都可能知道它如何执行的。

```javascript
1: let a = 3
2: function addTwo(x) {
3:   let ret = x + 2
4:   return ret
5: }
6: let b = addTwo(a)
7: console.log(b)
```

为了理解JavaScript引擎真正的工作原理，让我们详细分析一下。




